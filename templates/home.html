<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8">
  <title>世新教務｜查詢小工具</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Bootstrap CDN，快速做個乾淨的頁面 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { padding-top: 32px; }
    .container-narrow { max-width: 980px; }
    .form-hint { color:#6c757d; font-size: .9rem; }
    .sticky-footer { position: sticky; bottom: 0; background: #fff; padding: .75rem 0; border-top: 1px solid #eee; }
    table { font-size: 14px; }
    /* 查詢結果：表頭全部向左對齊 */
    .table thead th, table thead th { text-align: left !important; }
  </style>
</head>
<body>
<div class="container container-narrow">

  <h3 class="mb-3">世新教務｜查詢小工具</h3>
  <p class="text-muted">先選要查的類型並輸入學號密碼，送出後系統會自動比對並更新環境變數與資料，顯示並提供最新 CSV 下載。</p>

  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      {% for category, m in messages %}
        <div class="alert alert-{{ 'warning' if not category else category }}">
          <div>{{ m }}</div>
        </div>
      {% endfor %}
    {% endif %}
  {% endwith %}

  <form class="card p-3 mb-4" method="post" action="{{ url_for('query') }}">
    <div class="row g-3 align-items-center">
      <div class="col-md-4">
        <label class="form-label mb-0">查詢類型</label>
        <select class="form-select" name="kind" required>
          <option value="">— 請選擇 —</option>
          <option value="timetable" {% if kind=='timetable' %}selected{% endif %}>SC0106：課表《清單一》</option>
          <option value="grades"    {% if kind=='grades' %}selected{% endif %}>SD0101：歷年成績（課程/彙總）</option>
          <option value="ranking"   {% if kind=='ranking' %}selected{% endif %}>SD0104：歷年名次</option>
          <option value="attendance"{% if kind=='attendance' %}selected{% endif %}>SC0108：出缺勤記錄</option>
        </select>
      </div>
      <div class="col-md-4">
        <label class="form-label mb-0">關鍵字（可留空）</label>
        <input class="form-control" type="text" name="keyword" value="{{ keyword or '' }}" placeholder="科目、老師、教室、備註…">
        <div class="form-hint">對所有欄位做包含搜尋（不分大小寫）。</div>
      </div>
      <!-- 自動執行爬蟲：後端已改為每次送出自動比對/更新環境並執行爬蟲，此欄位移除 -->
    </div>

    <hr>

    <div class="row g-3">
      <div class="col-md-6">
        <label class="form-label">學號（覆寫 .env，可留空）</label>
        <input class="form-control" type="text" name="username" placeholder="不填則用 .env 的 SHU_USERNAME">
      </div>
      <div class="col-md-6">
        <label class="form-label">密碼（覆寫 .env，可留空）</label>
        <input class="form-control" type="password" name="password" placeholder="不填則用 .env 的 SHU_PASSWORD">
      </div>
    </div>

    <div class="d-flex gap-2 justify-content-end mt-3">
      <button class="btn btn-primary" type="submit">查詢</button>
      <button class="btn btn-outline-secondary" type="reset">清除</button>
    </div>
  </form>

  {% if result_table %}
    <div class="card">
      <div class="card-header d-flex justify-content-between align-items-center">
        <strong>查詢結果</strong>
        {% if csv_path %}
          <a class="btn btn-sm btn-success" href="{{ url_for('download') }}?path={{ csv_path|urlencode }}">
            下載目前這份 CSV
          </a>
        {% endif %}
      </div>
      <div class="card-body">
        <div class="table-responsive">
          {{ result_table|safe }}
        </div>
      </div>
      <div class="sticky-footer">
        <div class="small text-muted">
          資料來源：你本機的爬蟲輸出（{{ csv_path }}）
        </div>
      </div>
    </div>
  {% endif %}

  <div class="text-muted mt-4" style="font-size: 12px;">
    小提醒：若在雲端主機執行，請把 .env 的 <code>HEADLESS=True</code>，Selenium 才能無頭跑；Windows 本機可留空或 False。
  </div>

</div>
</body>
</html>
